<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Basement Noise • Sample Roulette</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Courier+Prime&display=swap" rel="stylesheet">

  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/addons/p5.sound.min.js"></script>

  <style>
    :root{
      --bg:#000; --panel:#0f0f10; --ink:#f3f3f3; --muted:#bcbcbc; --frame:#27272a; --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:"Courier Prime",monospace}
    a{color:inherit;text-decoration:none}

    /* Background layers (same as home) */
    #bgCanvas{ position:fixed; inset:0; z-index:0; }
    .scanlines{ position:fixed; inset:0; pointer-events:none; z-index:0;
      background: repeating-linear-gradient(to bottom,
        rgba(255,255,255,.02) 0px, rgba(255,255,255,.02) 1px,
        transparent 2px, transparent 3px); }
    .vignette{ position:fixed; inset:0; z-index:0; pointer-events:none;
      background: radial-gradient(ellipse at center, rgba(0,0,0,0) 40%, rgba(0,0,0,.55) 100%); }

    /* Header */
    .site-header{
      position:sticky; top:0; z-index:20;
      background:rgba(0,0,0,.85);
      border-bottom:1px solid #191919;
      backdrop-filter: blur(6px);
    }
    .bar{
      max-width:var(--maxw); margin:0 auto; padding:10px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:16px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{height:36px; width:auto; filter: drop-shadow(0 0 10px rgba(255,255,255,.12)); background:#111; border-radius:4px}
    .brand .name{ font-family:Orbitron, sans-serif; letter-spacing:2px; font-size:1rem;
      animation:glitch 2.2s linear infinite; }
    @keyframes glitch{
      0%,100%{ text-shadow:0 0 12px #fff, 2px -2px 0 #f00, -2px 2px 0 #0ff }
      50%    { text-shadow:0 0 12px #fff, -2px 2px 0 #f00, 2px -2px 0 #0ff }
    }
    nav a{display:inline-block; margin-left:10px; padding:6px 10px; border:1px solid #2e2e2e; border-radius:8px}
    nav a:hover{border-color:#fff; background:#fff; color:#000}

    /* Title */
    .hero{ max-width:var(--maxw); margin:26px auto 8px; padding:0 16px; text-align:center; position:relative; z-index:5; }
    .title{ font-family:Orbitron, sans-serif; letter-spacing:3px; font-size:2rem; margin:4px 0 6px; text-shadow:0 0 20px rgba(255,255,255,.08); }
    .subtitle{ color:var(--muted); margin:0; }

    /* Panel & controls (lightweight) */
    .wrap{ max-width:var(--maxw); margin:18px auto 40px; padding:0 16px; position:relative; z-index:5; }
    .panel{ background:rgba(15,15,16,.55); border:1px solid var(--frame); border-radius:14px; padding:18px; }
    .controls{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:0 0 12px; }
    .ui{ background:#111; color:#fff; border:1px solid #fff; border-radius:8px; padding:10px 14px; cursor:pointer;
         transition:.15s all ease; box-shadow:0 0 8px rgba(255,255,255,.15) inset; }
    .ui:hover{ background:#fff; color:#000 }
    .note{ color:#9f9f9f; font-size:.9rem; text-align:center; margin-top:10px }

    /* Wheel */
    #roulette-wrap{ position:relative; width:100%; max-width:820px; margin:0 auto; }
    #roulette{ display:block; width:100%; height:auto; }
    .pointer{
      position:absolute; right:-14px; top:50%; transform:translateY(-50%);
      width:0; height:0; border-left:14px solid #fff; border-top:10px solid transparent; border-bottom:10px solid transparent;
      filter: drop-shadow(0 0 6px rgba(255,255,255,.5));
    }
    .win-ring{ position:absolute; inset:0; pointer-events:none; border-radius:50%;
      box-shadow:0 0 0 0 rgba(255,255,255,.0); animation:winPulse .8s ease-out forwards; }
    @keyframes winPulse{ 0%{box-shadow:0 0 0 0 rgba(255,255,255,.8);} 100%{box-shadow:0 0 60px 28px rgba(255,255,255,0);} }

    footer{ color:#8a8a8a; font-size:.88rem; padding:26px 16px 40px; text-align:center; position:relative; z-index:5; }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="site-header">
    <div class="bar">
      <a class="brand" href="/basement-noise/">
        <img src="/basement-noise/basement_noise_logo_design.png" alt="Basement Noise"/>
        <span class="name">Basement Noise</span>
      </a>
      <nav>
        <a href="/basement-noise/">Home</a>
        <a href="/basement-noise/tools/wheel-decide/">Wheel Decide</a>
        <a href="/basement-noise/tools/producer-linker/">Producer Linker</a>
      </nav>
    </div>
  </div>

  <!-- Title -->
  <div class="hero">
    <h1 class="title">Sample Roulette</h1>
    <p class="subtitle">Upload samples, spin the wheel, and let the winner play—with a little retro celebration.</p>
  </div>

  <!-- Tool -->
  <main class="wrap">
    <section class="panel">
      <div class="controls">
        <button class="ui" onclick="SR_upload()">Upload Samples</button>
        <button class="ui" onclick="SR_spin()">Spin</button>
        <button class="ui" onclick="SR_clear()">Clear</button>
      </div>

      <div id="roulette-wrap">
        <div class="pointer"></div>
        <!-- p5.js canvas injected here -->
      </div>

      <p class="note">Tip: first click unlocks audio • drag to spin when idle • labels use your file names.</p>
    </section>
  </main>

  <footer>© Basement Noise</footer>

  <!-- Background canvas + overlays -->
  <canvas id="bgCanvas"></canvas>
  <div class="scanlines"></div>
  <div class="vignette"></div>

  <!-- Animated site background (same as home) -->
  <script>
    const bg = document.getElementById('bgCanvas');
    const bctx = bg.getContext('2d', { alpha:false });
    let BW, BH, BT = 0;
    function bgResize(){ BW = bg.width = innerWidth; BH = bg.height = innerHeight; }
    addEventListener('resize', bgResize); bgResize();
    function drawGrain(){
      const img = bctx.getImageData(0,0,BW,BH); const d = img.data;
      for(let i=0;i<d.length;i+=4){ const n = 8 + (Math.random()*12)|0; d[i]=d[i+1]=d[i+2]=n; }
      bctx.putImageData(img,0,0);
    }
    function drawStairs(){
      bctx.save(); bctx.globalAlpha=.05; bctx.strokeStyle='#fff'; bctx.lineWidth=2;
      const steps=6, bx=BW*0.12+Math.sin(BT*.0008)*BW*.02, by=BH*0.25+Math.cos(BT*.0006)*BH*.02;
      for(let s=0;s<steps;s++){ bctx.strokeRect(bx+s*26, by+s*18, 120, 34); }
      const rx=BW*0.75+Math.cos(BT*.0007)*BW*.02, ry=BH*0.68+Math.sin(BT*.0005)*BH*.02;
      for(let s=0;s<steps;s++){ bctx.strokeRect(rx-s*24, ry-s*16, 140, 36); }
      bctx.restore();
    }
    function btick(now){ BT = now; bctx.fillStyle='#000'; bctx.fillRect(0,0,BW,BH); drawGrain(); drawStairs(); requestAnimationFrame(btick); }
    requestAnimationFrame(btick);
  </script>

  <!-- Roulette (p5.js) -->
  <script>
    // ----- State -----
    let pg;                    // offscreen buffer
    let wheelSize, cx, cy;
    let angle = 0, spinVel = 0, spinning = false;
    let slices = [];           // [{name, fileUrl, sound}]
    let sliceAngle = 0;

    let audioReady = false;
    let confetti = [];
    let winIndex = -1;
    let lastPlayed = null;
    let isLoading = false;

    let tickOsc, tickEnv;      // subtle tick during spin

    const wrap = document.getElementById('roulette-wrap');
    let p5canvas;

    // Audio unlock + tiny tick setup
    function ensureAudio(){
      if (audioReady) return true;
      if (typeof userStartAudio === 'function'){ userStartAudio(); }
      try{
        tickOsc = new p5.Oscillator('square'); tickOsc.freq(880); tickOsc.amp(0); tickOsc.start();
        tickEnv = new p5.Envelope(); tickEnv.setADSR(0.001, 0.03, 0, 0.03); tickEnv.setRange(0.06, 0);
        audioReady = true; 
      }catch(e){ /* ignore */ }
      return true;
    }
    document.addEventListener('pointerdown', ensureAudio, { once:true });

    // Add files
    function addSamplesFromFiles(fileList){
      isLoading = true; rebuildWheel();
      const files = Array.from(fileList);
      if (!files.length){ isLoading = false; rebuildWheel(); return; }

      let left = files.length;
      const fresh = [];

      function doneOne(){ left--; if (left<=0){ isLoading = false; slices.push(...fresh); rebuildWheel(); } }

      for (const f of files){
        const url = URL.createObjectURL(f);
        loadSound(url,
          snd => { fresh.push({ name:f.name, fileUrl:url, sound:snd }); doneOne(); },
          err => { console.warn('loadSound error:', f.name, err); doneOne(); }
        );
      }
    }

    // p5
    function setup(){
      const sz = Math.max(360, Math.min(820, wrap.clientWidth || 0, window.innerWidth*0.9 || 0));
      p5canvas = createCanvas(sz, sz); 
      p5canvas.parent('roulette-wrap');
      p5canvas.elt.id = 'roulette';
      wrap.prepend(p5canvas.elt);

      wheelSize = sz; cx = wheelSize/2; cy = wheelSize/2;

      pixelDensity(1);
      textFont('Courier New');
      angleMode(RADIANS);

      pg = createGraphics(wheelSize, wheelSize);
      pg.angleMode(RADIANS); pg.textAlign(CENTER, CENTER); pg.textFont('Courier New');

      p5canvas.mousePressed(()=>ensureAudio());
      rebuildWheel();
    }

    function windowResized(){
      const sz = Math.max(360, Math.min(820, wrap.clientWidth || 0, window.innerWidth*0.9 || 0));
      if (sz && sz !== wheelSize){
        resizeCanvas(sz, sz);
        wheelSize = sz; cx = sz/2; cy = sz/2;
        pg = createGraphics(wheelSize, wheelSize);
        pg.angleMode(RADIANS); pg.textAlign(CENTER, CENTER); pg.textFont('Courier New');
        redrawWheel();
      }
    }

    function draw(){
      clear();

      if (spinning){
        angle += spinVel;
        spinVel *= 0.988;                 // friction
        if (tickEnv && random()<0.12){ tickEnv.play(tickOsc); }
        if (abs(spinVel) < 0.0022){
          spinVel = 0; spinning = false;
          snapToSlice();
          celebrate(winIndex);
          playWinner(winIndex);
        }
      }

      // wheel
      push();
      translate(cx, cy);
      rotate(angle);
      imageMode(CENTER);
      if (pg.width>0 && pg.height>0) image(pg, 0, 0);
      pop();

      // confetti
      for (let i = confetti.length - 1; i >= 0; i--){
        const p = confetti[i];
        p.vy += 0.15; p.x += p.vx; p.y += p.vy; p.life -= 1;
        noStroke(); fill(255, p.life*2); rect(p.x, p.y, 4, 4);
        if (p.life <= 0) confetti.splice(i, 1);
      }
    }

    function rebuildWheel(){ sliceAngle = TWO_PI / Math.max(1, slices.length || 1); redrawWheel(); }

    function redrawWheel(){
      if (pg.width<=0 || pg.height<=0) return;

      pg.clear();
      const r = wheelSize * 0.42;
      const rLabel = r * 0.72;

      // ring
      pg.noFill(); pg.stroke(255); pg.strokeWeight(2);
      pg.circle(wheelSize/2, wheelSize/2, r*2);

      if (isLoading){
        pg.noStroke(); pg.fill(150); pg.textSize(16);
        pg.text("Loading samples…", wheelSize/2, wheelSize/2);
        return;
      }
      if (!slices.length){
        pg.noStroke(); pg.fill(110); pg.textSize(14);
        pg.text("Click ‘Upload Samples’ to begin", wheelSize/2, wheelSize/2);
        return;
      }

      for (let i=0;i<slices.length;i++){
        const a0 = i*sliceAngle - HALF_PI;
        const a1 = a0 + sliceAngle;

        pg.noStroke(); pg.fill(i%2?30:40);
        pg.arc(wheelSize/2, wheelSize/2, r*2, r*2, a0, a1, PIE);

        pg.stroke(90); pg.strokeWeight(1);
        pg.line(wheelSize/2 + Math.cos(a0)*r, wheelSize/2 + Math.sin(a0)*r, wheelSize/2, wheelSize/2);

        // label (kept upright)
        pg.push();
        pg.translate(wheelSize/2, wheelSize/2);
        const mid = a0 + sliceAngle/2;
        pg.rotate(mid);
        pg.noStroke(); pg.fill(200); pg.textSize(12);
        if (mid > HALF_PI && mid < PI + HALF_PI){ pg.rotate(PI); pg.text(truncLabel(slices[i].name), 0, rLabel); }
        else { pg.text(truncLabel(slices[i].name), 0, -rLabel); }
        pg.pop();
      }

      // hub
      pg.noStroke(); pg.fill(0); pg.circle(wheelSize/2, wheelSize/2, 40);
      pg.stroke(255); pg.noFill(); pg.circle(wheelSize/2, wheelSize/2, 40);
    }

    function truncLabel(s){
      if (!s) return "[Unnamed]";
      const max = 22;
      if (s.length <= max) return s;
      const dot = s.lastIndexOf('.');
      const base = dot>0 ? s.slice(0, dot) : s;
      return base.length > max ? base.slice(0,max-1)+'…' : base;
    }

    // Spin
    function spin(){
      if (!slices.length || spinning) return;
      ensureAudio();
      // reset winner highlight/confetti
      winIndex = -1; confetti.length = 0; redrawWheel();

      spinVel = random(0.25, 0.35);
      spinning = true;

      if (lastPlayed && lastPlayed.isPlaying()) lastPlayed.stop();
    }

    function snapToSlice(){
      const facing = ((-angle) % TWO_PI + TWO_PI) % TWO_PI;
      const idx = floor(((facing + HALF_PI) % TWO_PI) / sliceAngle);
      winIndex = constrain(idx, 0, slices.length-1);

      const sliceMid = winIndex*sliceAngle + sliceAngle/2 - HALF_PI;
      angle = -sliceMid;

      drawWinnerEdge(winIndex);
    }

    function drawWinnerEdge(i){
      if (pg.width<=0 || pg.height<=0) return;
      const r = wheelSize * 0.42;
      const a0 = i*sliceAngle - HALF_PI, a1 = a0 + sliceAngle;
      pg.push(); pg.noFill(); pg.stroke(255); pg.strokeWeight(3);
      pg.arc(wheelSize/2, wheelSize/2, r*2+4, r*2+4, a0, a1); pg.pop();
    }

    function celebrate(i){
      const ring = document.createElement('div');
      ring.className = 'win-ring';
      wrap.appendChild(ring);
      setTimeout(()=>{ if (ring.parentElement===wrap) wrap.removeChild(ring); }, 820);

      const n = 70;
      for (let k=0;k<n;k++){
        confetti.push({ x:cx+(k%2?12:-12), y:cy, vx:random(-3,3), vy:random(-6,-2), life:random(40,70) });
      }
    }

    function playWinner(i){
      if (i<0 || i>=slices.length) return;
      const snd = slices[i].sound; if (!snd) return;
      if (lastPlayed && lastPlayed.isPlaying()) lastPlayed.stop();
      snd.stop(); snd.setVolume(0.9); snd.play(); lastPlayed = snd;
    }

    // Buttons
    window.SR_upload = () => {
      ensureAudio();
      const el = document.createElement('input');
      el.type = 'file'; el.accept = 'audio/*'; el.multiple = true;
      el.onchange = e => addSamplesFromFiles(e.target.files);
      el.click();
    };
    window.SR_spin = spin;
    window.SR_clear = () => {
      if (lastPlayed && lastPlayed.isPlaying()) lastPlayed.stop();
      slices.forEach(s => s.sound && s.sound.stop());
      isLoading = false;
      slices = []; winIndex = -1; angle = 0; spinVel = 0; spinning = false; confetti.length=0;
      rebuildWheel();
    };

    // Drag-to-spin (idle)
    let prevX = null, dragStartAngle = null;
    function mousePressed(){ if (mouseX>=0&&mouseX<=width&&mouseY>=0&&mouseY<=height){ prevX = mouseX; dragStartAngle = angle; } }
    function mouseDragged(){ if (!spinning && prevX!==null){ const dx = mouseX - prevX; angle += dx*0.005; prevX = mouseX; } }
    function mouseReleased(){
      prevX = null;
      if (!spinning && dragStartAngle!==null && dragStartAngle!==angle){
        snapToSlice(); playWinner(winIndex);
      }
      dragStartAngle = null;
    }
  </script>
</body>
</html>
